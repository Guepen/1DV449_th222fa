/**
 * Created by Tobias on 2014-12-04.
 */
function Map(a,b,c){this.latitude=a;this.longitude=b;this.zoom=c;this.infoWindow=undefined;this.markers=[];this.mapOptions={center:{lat:this.latitude,lng:this.longitude},zoom:this.zoom};this.map=new google.maps.Map(document.getElementById('mapCanvas'),this.mapOptions)}Map.prototype.addMarker=function(a,b){var c=this;var d=new google.maps.LatLng(a.latitude,a.longitude);var e=new google.maps.Marker({position:d,map:this.map,title:a.title});this.markers.push(e);google.maps.event.addListener(e,'click',function(){c.renderInfoWindow(a,e)});b.onclick=function(){c.renderInfoWindow(a,e)}};Map.prototype.removeMarkers=function(){this.markers.forEach(function(a){a.setMap(null)});this.markers=[]};Map.prototype.renderInfoWindow=function(a,b){if(this.infoWindow!==undefined){this.infoWindow.close()}var c="<div class='content'> "+"<h3>"+a.title+"</h3>"+"<h4>"+a.categoryText+"</h4>"+"<p>Rapporterat: "+a.getDate()+"</p>"+"<p>"+a.description+"</p>"+"<p> detaljerad platsbeskrivning: "+a.location+"</p>"+"</div>";this.infoWindow=new google.maps.InfoWindow({content:c,maxWidth:400});this.map.setZoom(10);this.infoWindow.open(this.map,b)};var TrafficBoard={swedenMap:undefined,trafficMessages:{"all":[],"roadTraffic":[],"publicTransport":[],"plannedInterference":[],"other":[]},roadTrafficCategory:0,publicTransportCategory:1,plannedInterferenceCategory:2,otherCategory:3,allCategories:4,init:function(){TrafficBoard.swedenMap=new Map(62.00,15.00,4);$("#categorySelect").change(function(){TrafficBoard.swedenMap.removeMarkers();TrafficBoard.swedenMap.map.setZoom(4);TrafficBoard.markers=[];$("#messageList").empty();TrafficBoard.messagesToAdd()});TrafficBoard.getTrafficPosts()},getTrafficPosts:function(){$.ajax({"type":"GET","url":"ajaxCalls/TrafficAlertsHandler.php","dataType":"json","data":{"mode":"getAlerts"},success:function(a){var b=a;var c=b["messages"];TrafficBoard.createMessages(c);TrafficBoard.messagesToAdd();TrafficBoard.renderCredit(b["copyright"])}})},createMessages:function(a){for(var i=0;i<a.length;i++){var b=new TrafficMessage(a[i].createddate,a[i].category,a[i].title,a[i].exactlocation,a[i].description,a[i].subcategory,a[i].latitude,a[i].longitude);TrafficBoard.pushMessage(b)}},pushMessage:function(a){switch(a.category){case TrafficBoard.roadTrafficCategory:TrafficBoard.trafficMessages.roadTraffic.push(a);TrafficBoard.trafficMessages.all.push(a);break;case TrafficBoard.publicTransportCategory:TrafficBoard.trafficMessages.publicTransport.push(a);TrafficBoard.trafficMessages.all.push(a);break;case TrafficBoard.plannedInterferenceCategory:TrafficBoard.trafficMessages.plannedInterference.push(a);TrafficBoard.trafficMessages.all.push(a);break;case TrafficBoard.otherCategory:TrafficBoard.trafficMessages.other.push(a);TrafficBoard.trafficMessages.all.push(a);break;default:alert("inga meddelade kunde hÃ¤mtas");break}},renderCredit:function(a){var b=document.getElementById("categoryDiv");var p=document.createElement("p");p.innerText=a;b.insertBefore(p,b.firstChild)},messagesToAdd:function(){switch(Number($("#categorySelect").val())){case TrafficBoard.allCategories:TrafficBoard.addMessageToList(TrafficBoard.trafficMessages.all);break;case TrafficBoard.roadTrafficCategory:TrafficBoard.addMessageToList(TrafficBoard.trafficMessages.roadTraffic);break;case TrafficBoard.publicTransportCategory:TrafficBoard.addMessageToList(TrafficBoard.trafficMessages.publicTransport);break;case TrafficBoard.plannedInterferenceCategory:TrafficBoard.addMessageToList(TrafficBoard.trafficMessages.plannedInterference);break;case TrafficBoard.otherCategory:TrafficBoard.addMessageToList(TrafficBoard.trafficMessages.other);break}},addMessageToList:function(f){var g=document.getElementById("messageList");var h=document.createElement("ul");f.forEach(function(a){var b=a.title;var c=document.createElement("div");var d=document.createElement("li");h.appendChild(d);var e=document.createElement("a");e.href="#";e.innerText=b;d.appendChild(e);g.insertBefore(d,g.firstChild);TrafficBoard.swedenMap.addMarker(a,e)})}};window.onload=TrafficBoard.init;function TrafficMessage(a,b,c,d,e,f,g,h,i){this.date=new Date(parseInt(a.replace("/Date(","").replace(")/",""),10));this.title=c;this.location=d;this.description=e;this.category=b;this.categoryText=f;this.latitude=g;this.longitude=h;this.marker=i}TrafficMessage.prototype.getDate=function(){var a=this.date.getFullYear();var b=(this.date.getMonth()+1);var c=this.date.getDate();var d=this.date.getHours();var e=this.date.getMinutes();return a+"-"+b+"-"+c+"  "+d+":"+e};